import{r as f,b as r,o,e as h,E as M,u as q,z as Q,H as P,a0 as m,c as z,d as t,m as R,g as s,f as _,k as Y,l as C,q as E,F as p,i as D,_ as G,a1 as O,L as K,T as A,M as Z,N as tt,O as et,P as at,Q as st,R as nt,S as ot,U as rt,V as lt,W as ct,X as ut,Y as it}from"./translate-DYXq8MLH.js";import{s as dt}from"./index-DIBRef73.js";import{_ as _t}from"./_plugin-vue_export-helper-DlAUqK2U.js";const vt=["disabled"],ht={key:0,class:"spinner-border spinner-border-sm me-2"},x={__name:"LoadingButton",props:{action:Function},setup(w){const l=w,v=f(!1);async function g(){v.value=!0;try{await l.action()}finally{v.value=!1}}return(n,y)=>(o(),r("button",{disabled:v.value,onClick:g,class:"btn btn-primary"},[v.value?(o(),r("span",ht)):h("",!0),M(n.$slots,"default")],8,vt))}},ft={class:"table table-sm table-bordered"},mt={class:"fixed150"},pt=["textContent"],kt=["textContent"],bt=["textContent"],wt=["textContent"],gt={key:0},yt={class:"my-2"},St={key:0},Rt={class:"my-2"},Ct={class:"my-2"},Et={key:1},Dt={class:"my-2"},xt={key:2},Ut={class:"table table-sm table-bordered"},$t={key:0},Lt={class:"link"},Tt=["href"],Nt={class:"me-2"},Ft=["href"],Pt={key:3},Ot={class:"table table-sm table-bordered"},At={key:0},Bt={class:"link"},Vt=["href"],Wt={key:0},It={class:"me-2"},Xt=["href"],jt={__name:"Crawler",setup(w){const{t:l}=q();let v=f({});const g=f(!1),n=f({}),y=f(!1),k=f("start"),d=f({total:0,error:0,saveStatus:0,nowReading:""});function L(){d.value.total=0,d.value.error=0,d.value.saveStatus=0,d.value.nowReading=0}const T=f(!1),N=f(!1);Q(()=>{console.log("startCrawler"),S()});async function B(){function e(a){try{const c=JSON.parse(a);return c&&typeof c=="object"?c:{}}catch{return{}}}const u=await m({command:"getCrawlerResults"});n.value=e(u.result),L();for(const a in n.value){d.value.total++;const c=O(n.value)[a];c.saveStatus&&d.value.saveStatus++,c.check!="ok"&&d.value.error++}}async function S(){try{g.value=!1,await P(),v.value=await m({command:"getIniParams"}),v.value.EXCLUDED_ROUTES=v.value.EXCLUDED_ROUTES.map(u=>{let a=U(u);return a=a.replace(/\/+$/,""),a}),v.value.RENDER_URL=v.value.RENDER_URL.map(u=>{let a=U(u);return a=a.replace(/\/+$/,""),a});const e=await m({command:"getDirStatus"});T.value=e.storageDirStatus,N.value=e.publicDirStatus,await B(),await P(),g.value=!0}catch(e){console.log(e)}}async function V(){const e=JSON.stringify(O(n.value),null,2);await m({command:"saveCrawlerResults",savedData:e})}function U(e){try{return new URL(e).href}catch{return new URL(e,location.origin).href}}function W(e){return[...new DOMParser().parseFromString(e,"text/html").querySelectorAll("a")].map(c=>c.getAttribute("href")).filter(Boolean)}async function I(){if(y.value)return;n.value={},k.value="working",L(),await F();for(const u of v.value.RENDER_URL)await $(u,"");await $("/","");let e={};Object.keys(n.value).sort().forEach(u=>{e[u]=n.value[u]}),n.value=e,await V(),k.value="start",await S()}async function $(e,u){if(d.value.nowReading=e,y.value||(e=e.replace(/#([^?]*)/g,""),e=U(e),v.value.EXCLUDED_ROUTES.some(i=>e.startsWith(i))))return;if(e in n.value){n.value[e].check!="ok"&&n.value[e].parentArr.push(u);return}n.value[e]={status:"reading",check:"unknown",saveStatus:!1,parentArr:[u]};const a=new URL(e),c=e.startsWith(location.origin)&&(v.value.RENDER_URL.some(i=>e.startsWith(i))||!a.pathname.includes("."));try{const i=await m({command:"processUrl",url:e,saveToFile:c});if(!i.check)throw new Error(i.code);if(d.value.total++,n.value[e].check="ok",n.value[e].saveStatus=i.saveStatus,i.saveStatus&&d.value.saveStatus++,!e.startsWith(location.origin))return;const H=W(i.body);for(const J of H){if(y.value)return;await $(J,e)}}catch(i){n.value[e].check=i.message,d.value.error++}finally{n.value[e].status="done"}}async function F(){await m({command:"deleteFromStorage"}),document.showToast(l("storage_deleted")),await S()}async function X(){await m({command:"deleteFromPublic"}),document.showToast(l("public_deleted")),await S()}async function j(){await m({command:"startHtmlCache"}),await S(),document.showToast(l("cache_published"))}return z(()=>{for(const e in n.value)if(n.value[e]?.check!="ok"&&n.value[e]?.check!="reading")return!0;return!1}),(e,u)=>(o(),r(p,null,[t("h2",null,s(_(l)("crawler")),1),t("table",ft,[t("tbody",null,[t("tr",null,[t("td",mt,s(_(l)("total")),1),t("td",null,[t("span",{textContent:s(d.value.total)},null,8,pt)])]),t("tr",null,[t("td",null,s(_(l)("errors")),1),t("td",null,[t("span",{textContent:s(d.value.error)},null,8,kt)])]),t("tr",null,[t("td",null,s(_(l)("saved")),1),t("td",null,[t("span",{textContent:s(d.value.saveStatus)},null,8,bt)])]),t("tr",null,[t("td",null,s(_(l)("now_reading")),1),t("td",null,[t("span",{textContent:s(d.value.nowReading)},null,8,wt)])])])]),g.value?(o(),r("div",gt,[t("div",yt,[k.value=="start"?(o(),Y(x,{key:0,action:I},{default:C(()=>[E(s(_(l)("start")),1)]),_:1})):h("",!0),k.value=="working"?(o(),r("button",{key:1,class:"btn btn-danger fas fa-stop ms-3",onClick:u[0]||(u[0]=a=>y.value=!0)})):h("",!0)]),T.value?(o(),r("div",St,[t("h4",null,s(_(l)("cache_created")),1),t("div",Rt,[R(x,{action:F},{default:C(()=>[E(s(_(l)("delete_storage")),1)]),_:1})]),t("div",Ct,[R(x,{action:j},{default:C(()=>[E(s(_(l)("publish_storage")),1)]),_:1})])])):h("",!0),N.value?(o(),r("div",Et,[t("h4",null,s(_(l)("cache_published")),1),t("div",Dt,[R(x,{action:X},{default:C(()=>[E(s(_(l)("delete_published_cache")),1)]),_:1})])])):h("",!0),k.value=="start"?(o(),r("div",xt,[t("h3",null,s(_(l)("errors")),1),t("table",Ut,[t("tbody",null,[(o(!0),r(p,null,D(n.value,(a,c)=>(o(),r(p,{key:c},[a.check!="ok"?(o(),r("tr",$t,[t("td",Lt,[t("a",{href:c,target:"_blank"},s(c),9,Tt)]),t("td",null,s(a.status),1),t("td",null,s(a.check),1),t("td",null,[(o(!0),r(p,null,D(a.parentArr,i=>(o(),r("span",Nt,[t("a",{href:i,target:"_blank"},s(i),9,Ft)]))),256))])])):h("",!0)],64))),128))])])])):h("",!0),k.value=="start"?(o(),r("div",Pt,[t("h3",null,s(_(l)("ok")),1),t("table",Ot,[t("tbody",null,[(o(!0),r(p,null,D(n.value,(a,c)=>(o(),r(p,{key:c},[a.check=="ok"?(o(),r("tr",At,[t("td",Bt,[t("a",{href:c,target:"_blank"},s(c),9,Vt)]),t("td",null,s(a.status),1),t("td",null,s(a.check),1),t("td",null,[a.saveStatus?(o(),r("span",Wt,s(_(l)("url_saved")),1)):h("",!0)]),t("td",null,[(o(!0),r(p,null,D(a.parentArr,i=>(o(),r("span",It,[t("a",{href:i,target:"_blank"},s(i),9,Xt)]))),256))])])):h("",!0)],64))),128))])])])):h("",!0)])):h("",!0),R(G)],64))}},Ht=_t(jt,[["__scopeId","data-v-c9aa854f"]]),Jt=[A,Z,tt,et,at,st,nt,ot,rt,dt],b=K(Ht);Jt.forEach(w=>{b.component(w.name,w)});b.use(lt,{theme:{preset:ct,options:{cssLayer:{name:"primevue",order:"theme, base, primevue"}}}});b.use(ut);b.use(A);b.use(it);b.mount("#crawler");
