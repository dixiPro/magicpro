import{r as f,l as n,p as r,s as u,Q as W,M as H,n as T,ab as _,d as M,q as a,G as k,E as g,H as w,F as p,A as S,B as m,Y as X,Z as F,_ as j,$ as q,a0 as J,a1 as Q,a2 as G,a3 as Y,a4 as Z,a5 as z,a6 as K,a7 as tt,a8 as et}from"./apiCall-DgoSpTMN.js";import{s as at}from"./index-CVxEeueg.js";import{_ as st}from"./ToastConfirm-BbyfyvMA.js";import{_ as nt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const rt=["disabled"],ot={key:0,class:"spinner-border spinner-border-sm me-2"},E={__name:"LoadingButton",props:{action:Function},setup(h){const c=h,d=f(!1);async function o(){d.value=!0;try{await c.action()}finally{d.value=!1}}return(v,R)=>(r(),n("button",{disabled:d.value,onClick:o,class:"btn btn-primary"},[d.value?(r(),n("span",ot)):u("",!0),W(v.$slots,"default")],8,rt))}},it={key:0},lt={class:"my-2"},ct={key:0},ut={class:"my-2"},dt={class:"my-2"},mt={key:1},ft={class:"my-2"},_t={key:2},pt={class:"table table-sm table-bordered"},vt={key:0},ht={class:"link"},kt=["href"],yt={class:"me-2"},bt=["href"],gt={key:3},wt={class:"table table-sm table-bordered"},St={key:0},Et={class:"link"},Rt=["href"],Ct={key:0},Dt={class:"me-2"},$t=["href"],Ut={__name:"Crawler",setup(h){let c=f({});const d=f(!1),o=f({}),v=f(!1),R=f("start"),D=f(!1),$=f(!1);H(()=>{console.log("startCrawler"),b()});async function N(){function t(s){try{const i=JSON.parse(s);return i&&typeof i=="object"?i:{}}catch{return{}}}const e=await _({command:"getCrawlerResults"});o.value=t(e.result)}async function b(){try{d.value=!1,await T(),c.value=await _({command:"getIniParams"}),c.value.EXCLUDED_ROUTES=c.value.EXCLUDED_ROUTES.map(e=>{let s=C(e);return s=s.replace(/\/+$/,""),s}),c.value.RENDER_URL=c.value.RENDER_URL.map(e=>{let s=C(e);return s=s.replace(/\/+$/,""),s});const t=await _({command:"getDirStatus"});D.value=t.storageDirStatus,$.value=t.publicDirStatus,await N(),await T(),d.value=!0}catch{}}function C(t){try{return new URL(t).href}catch{return new URL(t,location.origin).href}}function P(t){return[...new DOMParser().parseFromString(t,"text/html").querySelectorAll("a")].map(i=>i.getAttribute("href")).filter(Boolean)}async function A(){if(!v.value){o.value={},R.value="working",await L();for(const t of c.value.RENDER_URL)await U(t,"")}}async function U(t,e){if(v.value||(t=t.replace(/#([^?]*)/g,""),t=C(t),c.value.EXCLUDED_ROUTES.some(l=>t.startsWith(l))))return;if(t in o.value){o.value[t].check!="ok"&&o.value[t].parentArr.push(e);return}o.value[t]={status:"reading",check:"unknown",saveStatus:!1,parentArr:[e]};const s=new URL(t),i=t.startsWith(location.origin)&&(c.value.RENDER_URL.some(l=>t.startsWith(l))||!s.pathname.includes("."));console.log(i,t);try{const l=await _({command:"processUrl",url:t,saveToFile:i});if(!l.check)throw new Error(l.code);if(o.value[t].check="ok",o.value[t].saveStatus=l.saveStatus,console.log("saving",t,l.saveStatus),!t.startsWith(location.origin))return;const V=P(l.body);for(const I of V){if(v.value)return;await U(I,t)}}catch(l){o.value[t].check=l.message}finally{o.value[t].status="done"}}async function L(){await _({command:"deleteFromStorage"}),document.showToast("Storage удален"),await b()}async function x(){await _({command:"deleteFromPublic"}),document.showToast("Public удален"),await b()}async function O(){await _({command:"startHtmlCache"}),await b(),document.showToast("Кеш опубликован")}const B=M(()=>{for(const t in o.value)if(o.value[t]?.check!="ok"&&o.value[t]?.check!="reading")return!0;return!1});return(t,e)=>(r(),n(p,null,[e[9]||(e[9]=a("h1",null,"Crawler 0.81",-1)),d.value?(r(),n("div",it,[a("div",lt,[k(E,{action:A},{default:g(()=>[...e[1]||(e[1]=[w("Старт",-1)])]),_:1}),R.value=="working"?(r(),n("button",{key:0,class:"btn btn-danger fas fa-stop ms-3",onClick:e[0]||(e[0]=s=>v.value=!0)})):u("",!0)]),D.value?(r(),n("div",ct,[e[4]||(e[4]=a("h4",null,"Кеш создан",-1)),a("div",ut,[k(E,{action:L},{default:g(()=>[...e[2]||(e[2]=[w("Удалить сторадж",-1)])]),_:1})]),a("div",dt,[k(E,{action:O},{default:g(()=>[...e[3]||(e[3]=[w("Опубликовать сторадж",-1)])]),_:1})])])):u("",!0),$.value?(r(),n("div",mt,[e[6]||(e[6]=a("h4",null,"Кеш опубликован",-1)),a("div",ft,[k(E,{action:x},{default:g(()=>[...e[5]||(e[5]=[w("Удалить опубликованный кеш",-1)])]),_:1})])])):u("",!0),B.value?(r(),n("div",_t,[e[7]||(e[7]=a("h3",null,"Error",-1)),a("table",pt,[a("tbody",null,[(r(!0),n(p,null,S(o.value,(s,i)=>(r(),n(p,{key:i},[s.check!="ok"?(r(),n("tr",vt,[a("td",ht,[a("a",{href:i,target:"_blank"},m(i),9,kt)]),a("td",null,m(s.status),1),a("td",null,m(s.check),1),a("td",null,[(r(!0),n(p,null,S(s.parentArr,l=>(r(),n("span",yt,[a("a",{href:l,target:"_blank"},m(l),9,bt)]))),256))])])):u("",!0)],64))),128))])])])):u("",!0),Object.keys(o.value).length>0?(r(),n("div",gt,[e[8]||(e[8]=a("h3",null,"Ok",-1)),a("table",wt,[a("tbody",null,[(r(!0),n(p,null,S(o.value,(s,i)=>(r(),n(p,{key:i},[s.check=="ok"?(r(),n("tr",St,[a("td",Et,[a("a",{href:i,target:"_blank"},m(i),9,Rt)]),a("td",null,m(s.status),1),a("td",null,m(s.check),1),a("td",null,[s.saveStatus?(r(),n("span",Ct,"сохранен")):u("",!0)]),a("td",null,[(r(!0),n(p,null,S(s.parentArr,l=>(r(),n("span",Dt,[a("a",{href:l,target:"_blank"},m(l),9,$t)]))),256))])])):u("",!0)],64))),128))])])])):u("",!0)])):u("",!0),k(st)],64))}},Lt=nt(Ut,[["__scopeId","data-v-5f05cf25"]]),Tt=[F,j,q,J,Q,G,Y,Z,z,at],y=X(Lt);Tt.forEach(h=>{y.component(h.name,h)});y.use(K,{theme:{preset:tt,options:{cssLayer:{name:"primevue",order:"theme, base, primevue"}}}});y.use(et);y.use(F);y.mount("#crawler");
