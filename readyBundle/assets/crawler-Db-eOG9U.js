import{r as f,b as r,o,e as d,D as J,y as M,G as N,a0 as _,c as H,d as t,l as g,h as c,j as Q,k as S,m as R,F as h,g as C,_ as q,a1 as F,M as G,T as P,N as Y,O as z,P as K,Q as Z,R as tt,S as et,U as at,V as st,W as nt,X as ot,Y as rt}from"./ToastConfirm-G_dL-Wfl.js";import{s as lt}from"./index-B7fxN4Fg.js";import{_ as ut}from"./_plugin-vue_export-helper-DlAUqK2U.js";const it=["disabled"],ct={key:0,class:"spinner-border spinner-border-sm me-2"},E={__name:"LoadingButton",props:{action:Function},setup(w){const v=w,m=f(!1);async function n(){m.value=!0;try{await v.action()}finally{m.value=!1}}return(k,p)=>(o(),r("button",{disabled:m.value,onClick:n,class:"btn btn-primary"},[m.value?(o(),r("span",ct)):d("",!0),J(k.$slots,"default")],8,it))}},dt={class:"table table-sm table-bordered"},vt=["textContent"],ft=["textContent"],mt=["textContent"],_t=["textContent"],pt={key:0},ht={class:"my-2"},kt={key:0},wt={class:"my-2"},bt={class:"my-2"},yt={key:1},gt={class:"my-2"},St={key:2},Rt={class:"table table-sm table-bordered"},Ct={key:0},Et={class:"link"},Dt=["href"],xt={class:"me-2"},Ut=["href"],$t={key:3},Lt={class:"table table-sm table-bordered"},Tt={key:0},Nt={class:"link"},Ft=["href"],Pt={key:0},Ot={class:"me-2"},At=["href"],Bt={__name:"Crawler",setup(w){let v=f({});const m=f(!1),n=f({}),k=f(!1),p=f("start"),i=f({total:0,error:0,saveStatus:0,nowReading:""});function U(){i.value.total=0,i.value.error=0,i.value.saveStatus=0,i.value.nowReading=0}const $=f(!1),L=f(!1);M(()=>{console.log("startCrawler"),b()});async function O(){function a(s){try{const l=JSON.parse(s);return l&&typeof l=="object"?l:{}}catch{return{}}}const e=await _({command:"getCrawlerResults"});n.value=a(e.result),U();for(const s in n.value){i.value.total++;const l=F(n.value)[s];l.saveStatus&&i.value.saveStatus++,l.check!="ok"&&i.value.error++}}async function b(){try{m.value=!1,await N(),v.value=await _({command:"getIniParams"}),v.value.EXCLUDED_ROUTES=v.value.EXCLUDED_ROUTES.map(e=>{let s=D(e);return s=s.replace(/\/+$/,""),s}),v.value.RENDER_URL=v.value.RENDER_URL.map(e=>{let s=D(e);return s=s.replace(/\/+$/,""),s});const a=await _({command:"getDirStatus"});$.value=a.storageDirStatus,L.value=a.publicDirStatus,await O(),await N(),m.value=!0}catch(a){console.log(a)}}async function A(){const a=JSON.stringify(F(n.value),null,2);await _({command:"saveCrawlerResults",savedData:a})}function D(a){try{return new URL(a).href}catch{return new URL(a,location.origin).href}}function B(a){return[...new DOMParser().parseFromString(a,"text/html").querySelectorAll("a")].map(l=>l.getAttribute("href")).filter(Boolean)}async function V(){if(k.value)return;n.value={},p.value="working",U(),await T();for(const e of v.value.RENDER_URL)await x(e,"");await x("/","");let a={};Object.keys(n.value).sort().forEach(e=>{a[e]=n.value[e]}),n.value=a,await A(),p.value="start",await b()}async function x(a,e){if(i.value.nowReading=a,k.value||(a=a.replace(/#([^?]*)/g,""),a=D(a),v.value.EXCLUDED_ROUTES.some(u=>a.startsWith(u))))return;if(a in n.value){n.value[a].check!="ok"&&n.value[a].parentArr.push(e);return}n.value[a]={status:"reading",check:"unknown",saveStatus:!1,parentArr:[e]};const s=new URL(a),l=a.startsWith(location.origin)&&(v.value.RENDER_URL.some(u=>a.startsWith(u))||!s.pathname.includes("."));try{const u=await _({command:"processUrl",url:a,saveToFile:l});if(!u.check)throw new Error(u.code);if(i.value.total++,n.value[a].check="ok",n.value[a].saveStatus=u.saveStatus,u.saveStatus&&i.value.saveStatus++,!a.startsWith(location.origin))return;const X=B(u.body);for(const I of X){if(k.value)return;await x(I,a)}}catch(u){n.value[a].check=u.message,i.value.error++}finally{n.value[a].status="done"}}async function T(){await _({command:"deleteFromStorage"}),document.showToast("Storage удален"),await b()}async function W(){await _({command:"deleteFromPublic"}),document.showToast("Public удален"),await b()}async function j(){await _({command:"startHtmlCache"}),await b(),document.showToast("Кеш опубликован")}return H(()=>{for(const a in n.value)if(n.value[a]?.check!="ok"&&n.value[a]?.check!="reading")return!0;return!1}),(a,e)=>(o(),r(h,null,[e[13]||(e[13]=t("h1",null,"Crawler 0.9",-1)),t("table",dt,[t("tbody",null,[t("tr",null,[e[1]||(e[1]=t("td",{class:"fixed150"},"total",-1)),t("td",null,[t("span",{textContent:c(i.value.total)},null,8,vt)])]),t("tr",null,[e[2]||(e[2]=t("td",null,"errors",-1)),t("td",null,[t("span",{textContent:c(i.value.error)},null,8,ft)])]),t("tr",null,[e[3]||(e[3]=t("td",null,"saved",-1)),t("td",null,[t("span",{textContent:c(i.value.saveStatus)},null,8,mt)])]),t("tr",null,[e[4]||(e[4]=t("td",null,"nowReading",-1)),t("td",null,[t("span",{textContent:c(i.value.nowReading)},null,8,_t)])])])]),m.value?(o(),r("div",pt,[t("div",ht,[p.value=="start"?(o(),Q(E,{key:0,action:V},{default:S(()=>[...e[5]||(e[5]=[R("Старт",-1)])]),_:1})):d("",!0),p.value=="working"?(o(),r("button",{key:1,class:"btn btn-danger fas fa-stop ms-3",onClick:e[0]||(e[0]=s=>k.value=!0)})):d("",!0)]),$.value?(o(),r("div",kt,[e[8]||(e[8]=t("h4",null,"Кеш создан",-1)),t("div",wt,[g(E,{action:T},{default:S(()=>[...e[6]||(e[6]=[R("Удалить сторадж",-1)])]),_:1})]),t("div",bt,[g(E,{action:j},{default:S(()=>[...e[7]||(e[7]=[R("Опубликовать сторадж",-1)])]),_:1})])])):d("",!0),L.value?(o(),r("div",yt,[e[10]||(e[10]=t("h4",null,"Кеш опубликован",-1)),t("div",gt,[g(E,{action:W},{default:S(()=>[...e[9]||(e[9]=[R("Удалить опубликованный кеш",-1)])]),_:1})])])):d("",!0),p.value=="start"?(o(),r("div",St,[e[11]||(e[11]=t("h3",null,"Error",-1)),t("table",Rt,[t("tbody",null,[(o(!0),r(h,null,C(n.value,(s,l)=>(o(),r(h,{key:l},[s.check!="ok"?(o(),r("tr",Ct,[t("td",Et,[t("a",{href:l,target:"_blank"},c(l),9,Dt)]),t("td",null,c(s.status),1),t("td",null,c(s.check),1),t("td",null,[(o(!0),r(h,null,C(s.parentArr,u=>(o(),r("span",xt,[t("a",{href:u,target:"_blank"},c(u),9,Ut)]))),256))])])):d("",!0)],64))),128))])])])):d("",!0),p.value=="start"?(o(),r("div",$t,[e[12]||(e[12]=t("h3",null,"Ok",-1)),t("table",Lt,[t("tbody",null,[(o(!0),r(h,null,C(n.value,(s,l)=>(o(),r(h,{key:l},[s.check=="ok"?(o(),r("tr",Tt,[t("td",Nt,[t("a",{href:l,target:"_blank"},c(l),9,Ft)]),t("td",null,c(s.status),1),t("td",null,c(s.check),1),t("td",null,[s.saveStatus?(o(),r("span",Pt,"сохранен")):d("",!0)]),t("td",null,[(o(!0),r(h,null,C(s.parentArr,u=>(o(),r("span",Ot,[t("a",{href:u,target:"_blank"},c(u),9,At)]))),256))])])):d("",!0)],64))),128))])])])):d("",!0)])):d("",!0),g(q)],64))}},Vt=ut(Bt,[["__scopeId","data-v-3fa9fede"]]),Wt=[P,Y,z,K,Z,tt,et,at,st,lt],y=G(Vt);Wt.forEach(w=>{y.component(w.name,w)});y.use(nt,{theme:{preset:ot,options:{cssLayer:{name:"primevue",order:"theme, base, primevue"}}}});y.use(rt);y.use(P);y.mount("#crawler");
