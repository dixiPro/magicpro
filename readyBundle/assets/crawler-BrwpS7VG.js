import{r as m,l as a,p as n,s as f,Q as Z,U as z,V as tt,M as et,n as O,ab as _,X as st,d as R,C as j,q as s,G as k,E as y,H as w,F as d,A as p,B as u,Y as at,Z as B,_ as nt,$ as rt,a0 as ot,a1 as lt,a2 as ct,a3 as ut,a4 as it,a5 as dt,a6 as ft,a7 as ht,a8 as mt}from"./apiCall-DgoSpTMN.js";import{s as _t}from"./index-CVxEeueg.js";import{_ as kt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const pt=["disabled"],vt={key:0,class:"spinner-border spinner-border-sm me-2"},g={__name:"LoadingButton",props:{action:Function},setup(C){const P=C,v=m(!1);async function E(){v.value=!0;try{await P.action()}finally{v.value=!1}}return(x,r)=>(n(),a("button",{disabled:v.value,onClick:E,class:"btn btn-primary"},[v.value?(n(),a("span",vt)):f("",!0),Z(x.$slots,"default")],8,pt))}},bt={key:0},yt={class:"my-2"},wt={class:"my-2"},gt={key:0},Ct={class:"my-2"},Et={class:"my-2"},xt={class:"my-2"},St={key:1},Lt={class:"my-2"},$t={key:2},At={class:"table table-sm table-bordered"},Pt={key:0},Tt={class:"link"},Dt=["href"],Ft={class:"me-2"},Ut=["href"],Ot={key:3},Rt={class:"table table-sm table-bordered"},jt={key:0},Bt={class:"link"},Nt=["href"],Vt={class:"me-2"},qt=["href"],It={key:4},Ht={class:"table table-sm table-bordered"},Mt={key:0},Qt={class:"link"},Wt=["href"],Xt={class:"me-2"},Gt=["href"],Jt={key:5},Kt={class:"table table-sm table-bordered"},Yt={key:0},Zt={class:"link"},zt=["href"],te={class:"me-2"},ee=["href"],se={__name:"Crawler",setup(C){const P=z(),v=tt(),E=m({}),x=m(!1),r=m({}),l=m({}),b=m(!1),$=m("start"),N=m(!1),V=m(!1);let T=[];const q=["//","http://","https://"];et(()=>{console.log("startCrawler"),S(),document.showToast=(e="",t="success")=>{const i=t==="success"?5e3:6e4;P.add({severity:t,detail:e,life:i}),t==="error"&&console.log(e)},document.confirmDialog=async e=>new Promise((t,i)=>{v.require({message:e,header:"",icon:"fas fa-question",acceptLabel:"Да",rejectLabel:"Нет",accept:()=>t(!0),reject:()=>t(!1)})})});async function S(){try{x.value=!1,await O();const e=await _({command:"getIniParams"});E.value=e,T=e.EXCLUDED_ROUTES,T.push("#");const t=await _({command:"getCrawlerResults"});r.value="result"in t?t.result:{},l.value="extrnalLink"in t?t.extrnalLink:{},await O(),x.value=!0}catch{}}st(()=>{});async function I(){return await _({command:"saveCrawlerResults",savedData:{result:r.value,extrnalLink:l.value}})}async function F(e){return await _({command:"processUrl",url:e})}function H(e){try{return new URL(e).href}catch{return new URL(e,location.origin).href}}async function M(e){if(b.value)return;const t=await F(H(e));if(!t.check)throw new Error(t.code);const i=t.body;return[...new DOMParser().parseFromString(i,"text/html").querySelectorAll("a")].map(c=>c.getAttribute("href")).filter(Boolean)}async function Q(){if(b.value)return;r.value={},l.value={},$.value="working",await U(),await D("/","");for(const t of E.value.RENDER_URL)await D(t,"");let e={};Object.keys(r.value).sort().forEach(t=>{e[t]=r.value[t]}),r.value=e,await W(),e={},Object.keys(l.value).sort().forEach(t=>{e[t]=l.value[t]}),l.value=e,$.value="end",await S()}async function W(){if(!b.value)for(let e in l.value){const t=await F(e);l.value[e].status="done",l.value[e].check=t.check?"ok":t.code}}async function D(e,t){if(!b.value&&!T.some(i=>e.startsWith(i))){if(q.some(i=>e.startsWith(i))){e in l.value||(l.value[e]={status:"reading",check:"unknown",parentArr:[]}),l.value[e].parentArr.push(t);return}if(e in r.value){r.value[e].check!="ok"&&r.value[e].parentArr.push(t);return}r.value[e]={status:"reading",check:"unknown",parentArr:[t]};try{const i=await M(e);r.value[e].check="ok";for(const A of i){if(b.value)return;await D(A,e)}}catch(i){r.value[e].check=i.message}finally{r.value[e].status="done"}}}async function U(){await _({command:"deleteFromStorage"}),document.showToast("Storage удален"),await S()}async function X(){await _({command:"deleteFromPublic"}),document.showToast("Public удален"),await S()}async function G(){await _({command:"startHtmlCache"}),await S(),document.showToast("Кеш опубликован")}async function J(){const e=await _({command:"listCacheFiles"});r.value={},l.value={},e.forEach(t=>{r.value[t]={status:"file",check:"ok",parentArr:[]}}),$.value="end",document.showToast("кеш считан")}const K=R(()=>{for(const e in r.value)if(r.value[e]?.check!="ok"&&r.value[e]?.check!="reading")return!0;return!1}),Y=R(()=>{for(const e in l.value)if(r.value[e]?.check!="ok"&&r.value[e]?.check!="reading")return!0;return!1});return(e,t)=>{const i=j("Toast"),A=j("ConfirmDialog");return n(),a(d,null,[t[13]||(t[13]=s("h1",null,"Crawler 0.81",-1)),x.value?(n(),a("div",bt,[s("div",yt,[k(g,{action:I},{default:y(()=>[...t[1]||(t[1]=[w("Сохранить результаты",-1)])]),_:1})]),s("div",wt,[k(g,{action:Q},{default:y(()=>[...t[2]||(t[2]=[w("Старт",-1)])]),_:1}),$.value=="working"?(n(),a("button",{key:0,class:"btn btn-danger fas fa-stop ms-3",onClick:t[0]||(t[0]=o=>b.value=!0)})):f("",!0)]),N.value?(n(),a("div",gt,[t[6]||(t[6]=s("h4",null,"Кеш создан",-1)),s("div",Ct,[k(g,{action:J},{default:y(()=>[...t[3]||(t[3]=[w("Показать сторадж",-1)])]),_:1})]),s("div",Et,[k(g,{action:U},{default:y(()=>[...t[4]||(t[4]=[w("Удалить сторадж",-1)])]),_:1})]),s("div",xt,[k(g,{action:G},{default:y(()=>[...t[5]||(t[5]=[w("Опубликовать сторадж",-1)])]),_:1})])])):f("",!0),V.value?(n(),a("div",St,[t[8]||(t[8]=s("h4",null,"Кеш опубликован",-1)),s("div",Lt,[k(g,{action:X},{default:y(()=>[...t[7]||(t[7]=[w("Удалить опубликованный кеш",-1)])]),_:1})])])):f("",!0),K.value?(n(),a("div",$t,[t[9]||(t[9]=s("h3",null,"Error",-1)),s("table",At,[s("tbody",null,[(n(!0),a(d,null,p(r.value,(o,c)=>(n(),a(d,{key:c},[o.check!="ok"?(n(),a("tr",Pt,[s("td",Tt,[s("a",{href:c,target:"_blank"},u(c),9,Dt)]),s("td",null,u(o.status),1),s("td",null,u(o.check),1),s("td",null,[(n(!0),a(d,null,p(o.parentArr,h=>(n(),a("span",Ft,[s("a",{href:h,target:"_blank"},u(h),9,Ut)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),Object.keys(r.value).length>0?(n(),a("div",Ot,[t[10]||(t[10]=s("h3",null,"Ok",-1)),s("table",Rt,[s("tbody",null,[(n(!0),a(d,null,p(r.value,(o,c)=>(n(),a(d,{key:c},[o.check=="ok"?(n(),a("tr",jt,[s("td",Bt,[s("a",{href:c,target:"_blank"},u(c),9,Nt)]),s("td",null,u(o.status),1),s("td",null,u(o.check),1),s("td",null,[(n(!0),a(d,null,p(o.parentArr,h=>(n(),a("span",Vt,[s("a",{href:h,target:"_blank"},u(h),9,qt)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),Y.value?(n(),a("div",It,[t[11]||(t[11]=s("h2",null,"External Error",-1)),s("table",Ht,[s("tbody",null,[(n(!0),a(d,null,p(l.value,(o,c)=>(n(),a(d,{key:c},[o.check!="ok"?(n(),a("tr",Mt,[s("td",Qt,[s("a",{href:c,target:"_blank"},u(c),9,Wt)]),s("td",null,u(o.status),1),s("td",null,u(o.check),1),s("td",null,[(n(!0),a(d,null,p(o.parentArr,h=>(n(),a("span",Xt,[s("a",{href:h,target:"_blank"},u(h),9,Gt)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),Object.keys(l.value).length>1?(n(),a("div",Jt,[t[12]||(t[12]=s("h2",null,"External OK",-1)),s("table",Kt,[s("tbody",null,[(n(!0),a(d,null,p(l.value,(o,c)=>(n(),a(d,{key:c},[o.check=="ok"?(n(),a("tr",Yt,[s("td",Zt,[s("a",{href:c,target:"_blank"},u(c),9,zt)]),s("td",null,u(o.status),1),s("td",null,u(o.check),1),s("td",null,[(n(!0),a(d,null,p(o.parentArr,h=>(n(),a("span",te,[s("a",{href:h,target:"_blank"},u(h),9,ee)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),s("pre",null,"      "+u(JSON.stringify(E.value,null,2))+`
      `,1)])):f("",!0),k(i,{position:"top-left"}),k(A)],64)}}},ae=kt(se,[["__scopeId","data-v-ab9004d0"]]),ne=[B,nt,rt,ot,lt,ct,ut,it,dt,_t],L=at(ae);ne.forEach(C=>{L.component(C.name,C)});L.use(ft,{theme:{preset:ht,options:{cssLayer:{name:"primevue",order:"theme, base, primevue"}}}});L.use(mt);L.use(B);L.mount("#crawler");
