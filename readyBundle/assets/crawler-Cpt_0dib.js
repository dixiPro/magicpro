import{r as _,l as a,p as n,s as f,Q as Y,U as Z,V as z,M as tt,n as B,ab as k,X as et,d as N,C as R,q as s,G as p,E,H as S,F as d,A as m,B as c,Y as st,Z as V,_ as at,$ as nt,a0 as rt,a1 as ot,a2 as lt,a3 as ct,a4 as ut,a5 as it,a6 as dt,a7 as ft,a8 as ht}from"./apiCall-DgoSpTMN.js";import{s as _t}from"./index-CVxEeueg.js";import{_ as mt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const kt=["disabled"],pt={key:0,class:"spinner-border spinner-border-sm me-2"},$={__name:"LoadingButton",props:{action:Function},setup(y){const T=y,v=_(!1);async function w(){v.value=!0;try{await T.action()}finally{v.value=!1}}return(g,r)=>(n(),a("button",{disabled:v.value,onClick:w,class:"btn btn-primary"},[v.value?(n(),a("span",pt)):f("",!0),Y(g.$slots,"default")],8,kt))}},vt={key:0},bt={class:"my-2"},yt={key:0},wt={class:"my-2"},gt={class:"my-2"},Ct={class:"my-2"},Et={key:1},St={class:"my-2"},$t={key:2},xt={class:"table table-sm table-bordered"},At={key:0},Dt={class:"link"},Tt=["href"],Lt={class:"me-2"},Pt=["href"],Ft={key:3},Ut={class:"table table-sm table-bordered"},Ot={key:0},jt={class:"link"},Bt=["href"],Nt={class:"me-2"},Rt=["href"],Vt={key:4},qt={class:"table table-sm table-bordered"},It={key:0},Ht={class:"link"},Mt=["href"],Qt={class:"me-2"},Wt=["href"],Xt={key:5},Gt={class:"table table-sm table-bordered"},Jt={key:0},Kt={class:"link"},Yt=["href"],Zt={class:"me-2"},zt=["href"],te={__name:"Crawler",setup(y){const T=Z(),v=z(),w=_({}),g=_(!1),r=_({}),u=_({}),b=_(!1),A=_("start"),F=_(!1),U=_(!1);let L=[];const q=["//","http://","https://"];tt(()=>{console.log("startCrawler"),C(),document.showToast=(e="",t="success")=>{const i=t==="success"?5e3:6e4;T.add({severity:t,detail:e,life:i}),t==="error"&&console.log(e)},document.confirmDialog=async e=>new Promise((t,i)=>{v.require({message:e,header:"",icon:"fas fa-question",acceptLabel:"Да",rejectLabel:"Нет",accept:()=>t(!0),reject:()=>t(!1)})})});async function C(){try{g.value=!1,await B();const e=await k({command:"getIniParams"});w.value=e,L=e.EXCLUDED_ROUTES,L.push("#");const t=await k({command:"getDirStatus"});F.value=t.storageDirStatus,U.value=t.publicDirStatus,await B(),g.value=!0}catch{}}et(()=>{});async function O(e){return await k({command:"processUrl",url:e})}function I(e){try{return new URL(e).href}catch{return new URL(e,location.origin).href}}async function H(e){if(b.value)return;const t=await O(I(e));if(!t.check)throw new Error(t.code);const i=t.body;return[...new DOMParser().parseFromString(i,"text/html").querySelectorAll("a")].map(l=>l.getAttribute("href")).filter(Boolean)}async function M(){if(b.value)return;r.value={},u.value={},A.value="working",await j(),await P("/","");for(const t of w.value.RENDER_URL)await P(t,"");let e={};Object.keys(r.value).sort().forEach(t=>{e[t]=r.value[t]}),r.value=e,await Q(),e={},Object.keys(u.value).sort().forEach(t=>{e[t]=u.value[t]}),u.value=e,A.value="end",await C()}async function Q(){if(!b.value)for(let e in u.value){const t=await O(e);u.value[e].status="done",u.value[e].check=t.check?"ok":t.code}}async function P(e,t){if(!b.value&&!L.some(i=>e.startsWith(i))){if(q.some(i=>e.startsWith(i))){e in u.value||(u.value[e]={status:"reading",check:"unknown",parentArr:[]}),u.value[e].parentArr.push(t);return}if(e in r.value){r.value[e].check!="ok"&&r.value[e].parentArr.push(t);return}r.value[e]={status:"reading",check:"unknown",parentArr:[t]};try{const i=await H(e);r.value[e].check="ok";for(const D of i){if(b.value)return;await P(D,e)}}catch(i){r.value[e].check=i.message}finally{r.value[e].status="done"}}}async function j(){await k({command:"deleteFromStorage"}),document.showToast("Storage удален"),await C()}async function W(){await k({command:"deleteFromPublic"}),document.showToast("Public удален"),await C()}async function X(){await k({command:"startHtmlCache"}),await C(),document.showToast("Кеш опубликован")}async function G(){const e=await k({command:"listCacheFiles"});r.value={},u.value={},e.forEach(t=>{r.value[t]={status:"file",check:"ok",parentArr:[]}}),A.value="end",document.showToast("кеш считан")}const J=N(()=>{for(const e in r.value)if(r.value[e]?.check!="ok"&&r.value[e]?.check!="reading")return!0;return!1}),K=N(()=>{for(const e in u.value)if(r.value[e]?.check!="ok"&&r.value[e]?.check!="reading")return!0;return!1});return(e,t)=>{const i=R("Toast"),D=R("ConfirmDialog");return n(),a(d,null,[t[12]||(t[12]=s("h1",null,"Crawler 0.8",-1)),g.value?(n(),a("div",vt,[s("div",bt,[p($,{action:M},{default:E(()=>[...t[1]||(t[1]=[S("Старт",-1)])]),_:1}),A.value=="working"?(n(),a("button",{key:0,class:"btn btn-danger fas fa-stop ms-3",onClick:t[0]||(t[0]=o=>b.value=!0)})):f("",!0)]),F.value?(n(),a("div",yt,[t[5]||(t[5]=s("h4",null,"Кеш создан",-1)),s("div",wt,[p($,{action:G},{default:E(()=>[...t[2]||(t[2]=[S("Показать сторадж",-1)])]),_:1})]),s("div",gt,[p($,{action:j},{default:E(()=>[...t[3]||(t[3]=[S("Удалить сторадж",-1)])]),_:1})]),s("div",Ct,[p($,{action:X},{default:E(()=>[...t[4]||(t[4]=[S("Опубликовать сторадж",-1)])]),_:1})])])):f("",!0),U.value?(n(),a("div",Et,[t[7]||(t[7]=s("h4",null,"Кеш опубликован",-1)),s("div",St,[p($,{action:W},{default:E(()=>[...t[6]||(t[6]=[S("Удалить опубликованный кеш",-1)])]),_:1})])])):f("",!0),J.value?(n(),a("div",$t,[t[8]||(t[8]=s("h3",null,"Error",-1)),s("table",xt,[s("tbody",null,[(n(!0),a(d,null,m(r.value,(o,l)=>(n(),a(d,{key:l},[o.check!="ok"?(n(),a("tr",At,[s("td",Dt,[s("a",{href:l,target:"_blank"},c(l),9,Tt)]),s("td",null,c(o.status),1),s("td",null,c(o.check),1),s("td",null,[(n(!0),a(d,null,m(o.parentArr,h=>(n(),a("span",Lt,[s("a",{href:h,target:"_blank"},c(h),9,Pt)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),Object.keys(r.value).length>0?(n(),a("div",Ft,[t[9]||(t[9]=s("h3",null,"Ok",-1)),s("table",Ut,[s("tbody",null,[(n(!0),a(d,null,m(r.value,(o,l)=>(n(),a(d,{key:l},[o.check=="ok"?(n(),a("tr",Ot,[s("td",jt,[s("a",{href:l,target:"_blank"},c(l),9,Bt)]),s("td",null,c(o.status),1),s("td",null,c(o.check),1),s("td",null,[(n(!0),a(d,null,m(o.parentArr,h=>(n(),a("span",Nt,[s("a",{href:h,target:"_blank"},c(h),9,Rt)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),K.value?(n(),a("div",Vt,[t[10]||(t[10]=s("h2",null,"External Error",-1)),s("table",qt,[s("tbody",null,[(n(!0),a(d,null,m(u.value,(o,l)=>(n(),a(d,{key:l},[o.check!="ok"?(n(),a("tr",It,[s("td",Ht,[s("a",{href:l,target:"_blank"},c(l),9,Mt)]),s("td",null,c(o.status),1),s("td",null,c(o.check),1),s("td",null,[(n(!0),a(d,null,m(o.parentArr,h=>(n(),a("span",Qt,[s("a",{href:h,target:"_blank"},c(h),9,Wt)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),Object.keys(u.value).length>1?(n(),a("div",Xt,[t[11]||(t[11]=s("h2",null,"External OK",-1)),s("table",Gt,[s("tbody",null,[(n(!0),a(d,null,m(u.value,(o,l)=>(n(),a(d,{key:l},[o.check=="ok"?(n(),a("tr",Jt,[s("td",Kt,[s("a",{href:l,target:"_blank"},c(l),9,Yt)]),s("td",null,c(o.status),1),s("td",null,c(o.check),1),s("td",null,[(n(!0),a(d,null,m(o.parentArr,h=>(n(),a("span",Zt,[s("a",{href:h,target:"_blank"},c(h),9,zt)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),s("pre",null,"      "+c(JSON.stringify(w.value,null,2))+`
      `,1)])):f("",!0),p(i,{position:"top-left"}),p(D)],64)}}},ee=mt(te,[["__scopeId","data-v-0f84a1d0"]]),se=[V,at,nt,rt,ot,lt,ct,ut,it,_t],x=st(ee);se.forEach(y=>{x.component(y.name,y)});x.use(dt,{theme:{preset:ft,options:{cssLayer:{name:"primevue",order:"theme, base, primevue"}}}});x.use(ht);x.use(V);x.mount("#crawler");
