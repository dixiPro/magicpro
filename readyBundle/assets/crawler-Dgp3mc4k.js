import{r as f,l as r,p as o,s as d,Q as J,M,n as F,ab as p,d as X,q as t,G as g,B as c,D as q,E as S,H as R,F as h,A as C,t as N,Y as Q,Z as P,_ as G,$ as Y,a0 as Z,a1 as z,a2 as K,a3 as tt,a4 as et,a5 as at,a6 as st,a7 as nt,a8 as ot}from"./apiCall-DgoSpTMN.js";import{s as rt}from"./index-CVxEeueg.js";import{_ as lt}from"./ToastConfirm-BbyfyvMA.js";import{_ as ut}from"./_plugin-vue_export-helper-DlAUqK2U.js";const it=["disabled"],ct={key:0,class:"spinner-border spinner-border-sm me-2"},E={__name:"LoadingButton",props:{action:Function},setup(w){const v=w,m=f(!1);async function n(){m.value=!0;try{await v.action()}finally{m.value=!1}}return(k,_)=>(o(),r("button",{disabled:m.value,onClick:n,class:"btn btn-primary"},[m.value?(o(),r("span",ct)):d("",!0),J(k.$slots,"default")],8,it))}},dt={class:"table table-sm table-bordered"},vt=["textContent"],ft=["textContent"],mt=["textContent"],pt=["textContent"],_t={key:0},ht={class:"my-2"},kt={key:0},wt={class:"my-2"},bt={class:"my-2"},yt={key:1},gt={class:"my-2"},St={key:2},Rt={class:"table table-sm table-bordered"},Ct={key:0},Et={class:"link"},Dt=["href"],$t={class:"me-2"},xt=["href"],Ut={key:3},Lt={class:"table table-sm table-bordered"},Tt={key:0},Ft={class:"link"},Nt=["href"],Pt={key:0},At={class:"me-2"},Ot=["href"],Bt={__name:"Crawler",setup(w){let v=f({});const m=f(!1),n=f({}),k=f(!1),_=f("start"),i=f({total:0,error:0,saveStatus:0,nowReading:""});function x(){i.value.total=0,i.value.error=0,i.value.saveStatus=0,i.value.nowReading=0}const U=f(!1),L=f(!1);M(()=>{console.log("startCrawler"),b()});async function A(){function a(s){try{const l=JSON.parse(s);return l&&typeof l=="object"?l:{}}catch{return{}}}const e=await p({command:"getCrawlerResults"});n.value=a(e.result),x();for(const s in n.value){i.value.total++;const l=N(n.value)[s];l.saveStatus&&i.value.saveStatus++,l.check!="ok"&&i.value.error++}}async function b(){try{m.value=!1,await F(),v.value=await p({command:"getIniParams"}),v.value.EXCLUDED_ROUTES=v.value.EXCLUDED_ROUTES.map(e=>{let s=D(e);return s=s.replace(/\/+$/,""),s}),v.value.RENDER_URL=v.value.RENDER_URL.map(e=>{let s=D(e);return s=s.replace(/\/+$/,""),s});const a=await p({command:"getDirStatus"});U.value=a.storageDirStatus,L.value=a.publicDirStatus,await A(),await F(),m.value=!0}catch(a){console.log(a)}}async function O(){const a=JSON.stringify(N(n.value),null,2);await p({command:"saveCrawlerResults",savedData:a})}function D(a){try{return new URL(a).href}catch{return new URL(a,location.origin).href}}function B(a){return[...new DOMParser().parseFromString(a,"text/html").querySelectorAll("a")].map(l=>l.getAttribute("href")).filter(Boolean)}async function V(){if(k.value)return;n.value={},_.value="working",x(),await T();for(const e of v.value.RENDER_URL)await $(e,"");await $("/","");let a={};Object.keys(n.value).sort().forEach(e=>{a[e]=n.value[e]}),n.value=a,await O(),_.value="start",await b()}async function $(a,e){if(i.value.nowReading=a,k.value||(a=a.replace(/#([^?]*)/g,""),a=D(a),v.value.EXCLUDED_ROUTES.some(u=>a.startsWith(u))))return;if(a in n.value){n.value[a].check!="ok"&&n.value[a].parentArr.push(e);return}n.value[a]={status:"reading",check:"unknown",saveStatus:!1,parentArr:[e]};const s=new URL(a),l=a.startsWith(location.origin)&&(v.value.RENDER_URL.some(u=>a.startsWith(u))||!s.pathname.includes("."));try{const u=await p({command:"processUrl",url:a,saveToFile:l});if(!u.check)throw new Error(u.code);if(i.value.total++,n.value[a].check="ok",n.value[a].saveStatus=u.saveStatus,u.saveStatus&&i.value.saveStatus++,!a.startsWith(location.origin))return;const H=B(u.body);for(const I of H){if(k.value)return;await $(I,a)}}catch(u){n.value[a].check=u.message,i.value.error++}finally{n.value[a].status="done"}}async function T(){await p({command:"deleteFromStorage"}),document.showToast("Storage удален"),await b()}async function W(){await p({command:"deleteFromPublic"}),document.showToast("Public удален"),await b()}async function j(){await p({command:"startHtmlCache"}),await b(),document.showToast("Кеш опубликован")}return X(()=>{for(const a in n.value)if(n.value[a]?.check!="ok"&&n.value[a]?.check!="reading")return!0;return!1}),(a,e)=>(o(),r(h,null,[e[13]||(e[13]=t("h1",null,"Crawler 0.9",-1)),t("table",dt,[t("tbody",null,[t("tr",null,[e[1]||(e[1]=t("td",{class:"fixed150"},"total",-1)),t("td",null,[t("span",{textContent:c(i.value.total)},null,8,vt)])]),t("tr",null,[e[2]||(e[2]=t("td",null,"errors",-1)),t("td",null,[t("span",{textContent:c(i.value.error)},null,8,ft)])]),t("tr",null,[e[3]||(e[3]=t("td",null,"saved",-1)),t("td",null,[t("span",{textContent:c(i.value.saveStatus)},null,8,mt)])]),t("tr",null,[e[4]||(e[4]=t("td",null,"nowReading",-1)),t("td",null,[t("span",{textContent:c(i.value.nowReading)},null,8,pt)])])])]),m.value?(o(),r("div",_t,[t("div",ht,[_.value=="start"?(o(),q(E,{key:0,action:V},{default:S(()=>[...e[5]||(e[5]=[R("Старт",-1)])]),_:1})):d("",!0),_.value=="working"?(o(),r("button",{key:1,class:"btn btn-danger fas fa-stop ms-3",onClick:e[0]||(e[0]=s=>k.value=!0)})):d("",!0)]),U.value?(o(),r("div",kt,[e[8]||(e[8]=t("h4",null,"Кеш создан",-1)),t("div",wt,[g(E,{action:T},{default:S(()=>[...e[6]||(e[6]=[R("Удалить сторадж",-1)])]),_:1})]),t("div",bt,[g(E,{action:j},{default:S(()=>[...e[7]||(e[7]=[R("Опубликовать сторадж",-1)])]),_:1})])])):d("",!0),L.value?(o(),r("div",yt,[e[10]||(e[10]=t("h4",null,"Кеш опубликован",-1)),t("div",gt,[g(E,{action:W},{default:S(()=>[...e[9]||(e[9]=[R("Удалить опубликованный кеш",-1)])]),_:1})])])):d("",!0),_.value=="start"?(o(),r("div",St,[e[11]||(e[11]=t("h3",null,"Error",-1)),t("table",Rt,[t("tbody",null,[(o(!0),r(h,null,C(n.value,(s,l)=>(o(),r(h,{key:l},[s.check!="ok"?(o(),r("tr",Ct,[t("td",Et,[t("a",{href:l,target:"_blank"},c(l),9,Dt)]),t("td",null,c(s.status),1),t("td",null,c(s.check),1),t("td",null,[(o(!0),r(h,null,C(s.parentArr,u=>(o(),r("span",$t,[t("a",{href:u,target:"_blank"},c(u),9,xt)]))),256))])])):d("",!0)],64))),128))])])])):d("",!0),_.value=="start"?(o(),r("div",Ut,[e[12]||(e[12]=t("h3",null,"Ok",-1)),t("table",Lt,[t("tbody",null,[(o(!0),r(h,null,C(n.value,(s,l)=>(o(),r(h,{key:l},[s.check=="ok"?(o(),r("tr",Tt,[t("td",Ft,[t("a",{href:l,target:"_blank"},c(l),9,Nt)]),t("td",null,c(s.status),1),t("td",null,c(s.check),1),t("td",null,[s.saveStatus?(o(),r("span",Pt,"сохранен")):d("",!0)]),t("td",null,[(o(!0),r(h,null,C(s.parentArr,u=>(o(),r("span",At,[t("a",{href:u,target:"_blank"},c(u),9,Ot)]))),256))])])):d("",!0)],64))),128))])])])):d("",!0)])):d("",!0),g(lt)],64))}},Vt=ut(Bt,[["__scopeId","data-v-3fa9fede"]]),Wt=[P,G,Y,Z,z,K,tt,et,at,rt],y=Q(Vt);Wt.forEach(w=>{y.component(w.name,w)});y.use(st,{theme:{preset:nt,options:{cssLayer:{name:"primevue",order:"theme, base, primevue"}}}});y.use(ot);y.use(P);y.mount("#crawler");
