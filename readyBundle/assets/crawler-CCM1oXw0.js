import{r as v,l as r,p as o,s as c,Q as j,M as H,n as T,ab as m,d as J,q as a,G as w,E as g,H as S,F as _,A as E,B as f,t as M,Y as X,Z as F,_ as q,$ as Q,a0 as G,a1 as Y,a2 as Z,a3 as z,a4 as K,a5 as tt,a6 as et,a7 as at,a8 as st}from"./apiCall-DgoSpTMN.js";import{s as nt}from"./index-CVxEeueg.js";import{_ as rt}from"./ToastConfirm-BbyfyvMA.js";import{_ as ot}from"./_plugin-vue_export-helper-DlAUqK2U.js";const lt=["disabled"],it={key:0,class:"spinner-border spinner-border-sm me-2"},R={__name:"LoadingButton",props:{action:Function},setup(h){const u=h,d=v(!1);async function n(){d.value=!0;try{await u.action()}finally{d.value=!1}}return(p,b)=>(o(),r("button",{disabled:d.value,onClick:n,class:"btn btn-primary"},[d.value?(o(),r("span",it)):c("",!0),j(p.$slots,"default")],8,lt))}},ut={key:0},ct={class:"my-2"},dt={key:0},mt={class:"my-2"},ft={class:"my-2"},vt={key:1},_t={class:"my-2"},pt={key:2},ht={class:"table table-sm table-bordered"},kt={key:0},wt={class:"link"},yt=["href"],bt={class:"me-2"},gt=["href"],St={key:3},Et={class:"table table-sm table-bordered"},Rt={key:0},Dt={class:"link"},Ct=["href"],$t={key:0},Ut={class:"me-2"},Lt=["href"],Tt={__name:"Crawler",setup(h){let u=v({});const d=v(!1),n=v({}),p=v(!1),b=v("start"),$=v(!1),U=v(!1);H(()=>{console.log("startCrawler"),k()});async function N(){function t(s){try{const l=JSON.parse(s);return l&&typeof l=="object"?l:{}}catch{return{}}}const e=await m({command:"getCrawlerResults"});n.value=t(e.result)}async function k(){try{d.value=!1,await T(),u.value=await m({command:"getIniParams"}),u.value.EXCLUDED_ROUTES=u.value.EXCLUDED_ROUTES.map(e=>{let s=D(e);return s=s.replace(/\/+$/,""),s}),u.value.RENDER_URL=u.value.RENDER_URL.map(e=>{let s=D(e);return s=s.replace(/\/+$/,""),s});const t=await m({command:"getDirStatus"});$.value=t.storageDirStatus,U.value=t.publicDirStatus,await N(),await T(),d.value=!0}catch{}}async function O(){const t=JSON.stringify(M(n.value),null,2);await m({command:"saveCrawlerResults",savedData:t})}function D(t){try{return new URL(t).href}catch{return new URL(t,location.origin).href}}function P(t){return[...new DOMParser().parseFromString(t,"text/html").querySelectorAll("a")].map(l=>l.getAttribute("href")).filter(Boolean)}async function A(){if(p.value)return;n.value={},b.value="working",await L();for(const e of u.value.RENDER_URL)await C(e,"");await C("/","");let t={};Object.keys(n.value).sort().forEach(e=>{t[e]=n.value[e]}),n.value=t,await O(),b.value="end",await k()}async function C(t,e){if(p.value||(t=t.replace(/#([^?]*)/g,""),t=D(t),u.value.EXCLUDED_ROUTES.some(i=>t.startsWith(i))))return;if(t in n.value){n.value[t].check!="ok"&&n.value[t].parentArr.push(e);return}n.value[t]={status:"reading",check:"unknown",saveStatus:!1,parentArr:[e]};const s=new URL(t),l=t.startsWith(location.origin)&&(u.value.RENDER_URL.some(i=>t.startsWith(i))||!s.pathname.includes("."));console.log(l,t);try{const i=await m({command:"processUrl",url:t,saveToFile:l});if(!i.check)throw new Error(i.code);if(n.value[t].check="ok",n.value[t].saveStatus=i.saveStatus,console.log("saving",t,i.saveStatus),!t.startsWith(location.origin))return;const I=P(i.body);for(const W of I){if(p.value)return;await C(W,t)}}catch(i){n.value[t].check=i.message}finally{n.value[t].status="done"}}async function L(){await m({command:"deleteFromStorage"}),document.showToast("Storage удален"),await k()}async function x(){await m({command:"deleteFromPublic"}),document.showToast("Public удален"),await k()}async function B(){await m({command:"startHtmlCache"}),await k(),document.showToast("Кеш опубликован")}const V=J(()=>{for(const t in n.value)if(n.value[t]?.check!="ok"&&n.value[t]?.check!="reading")return!0;return!1});return(t,e)=>(o(),r(_,null,[e[9]||(e[9]=a("h1",null,"Crawler 0.81",-1)),d.value?(o(),r("div",ut,[a("div",ct,[w(R,{action:A},{default:g(()=>[...e[1]||(e[1]=[S("Старт",-1)])]),_:1}),b.value=="working"?(o(),r("button",{key:0,class:"btn btn-danger fas fa-stop ms-3",onClick:e[0]||(e[0]=s=>p.value=!0)})):c("",!0)]),$.value?(o(),r("div",dt,[e[4]||(e[4]=a("h4",null,"Кеш создан",-1)),a("div",mt,[w(R,{action:L},{default:g(()=>[...e[2]||(e[2]=[S("Удалить сторадж",-1)])]),_:1})]),a("div",ft,[w(R,{action:B},{default:g(()=>[...e[3]||(e[3]=[S("Опубликовать сторадж",-1)])]),_:1})])])):c("",!0),U.value?(o(),r("div",vt,[e[6]||(e[6]=a("h4",null,"Кеш опубликован",-1)),a("div",_t,[w(R,{action:x},{default:g(()=>[...e[5]||(e[5]=[S("Удалить опубликованный кеш",-1)])]),_:1})])])):c("",!0),V.value?(o(),r("div",pt,[e[7]||(e[7]=a("h3",null,"Error",-1)),a("table",ht,[a("tbody",null,[(o(!0),r(_,null,E(n.value,(s,l)=>(o(),r(_,{key:l},[s.check!="ok"?(o(),r("tr",kt,[a("td",wt,[a("a",{href:l,target:"_blank"},f(l),9,yt)]),a("td",null,f(s.status),1),a("td",null,f(s.check),1),a("td",null,[(o(!0),r(_,null,E(s.parentArr,i=>(o(),r("span",bt,[a("a",{href:i,target:"_blank"},f(i),9,gt)]))),256))])])):c("",!0)],64))),128))])])])):c("",!0),Object.keys(n.value).length>0?(o(),r("div",St,[e[8]||(e[8]=a("h3",null,"Ok",-1)),a("table",Et,[a("tbody",null,[(o(!0),r(_,null,E(n.value,(s,l)=>(o(),r(_,{key:l},[s.check=="ok"?(o(),r("tr",Rt,[a("td",Dt,[a("a",{href:l,target:"_blank"},f(l),9,Ct)]),a("td",null,f(s.status),1),a("td",null,f(s.check),1),a("td",null,[s.saveStatus?(o(),r("span",$t,"сохранен")):c("",!0)]),a("td",null,[(o(!0),r(_,null,E(s.parentArr,i=>(o(),r("span",Ut,[a("a",{href:i,target:"_blank"},f(i),9,Lt)]))),256))])])):c("",!0)],64))),128))])])])):c("",!0)])):c("",!0),w(rt)],64))}},Ft=ot(Tt,[["__scopeId","data-v-2ef5a5f5"]]),Nt=[F,q,Q,G,Y,Z,z,K,tt,nt],y=X(Ft);Nt.forEach(h=>{y.component(h.name,h)});y.use(et,{theme:{preset:at,options:{cssLayer:{name:"primevue",order:"theme, base, primevue"}}}});y.use(st);y.use(F);y.mount("#crawler");
//# sourceMappingURL=crawler-CCM1oXw0.js.map
