import{b as g,c as n,o,y as f,r as W,Y as z,Z as G,R as Q,$ as Y,af as v,p as B,I as O,a as s,L as h,M as k,D as Z,K as y,F as u,G as m,H as i,a0 as J,a1 as D,a2 as X,a3 as tt,a4 as et,a5 as st,a6 as at,a7 as nt,a8 as ot,a9 as rt,aa as lt,ab as ct,ac as it}from"./apiCall-CPsueVi4.js";import{s as ut}from"./index-DQP_ltDA.js";import{_ as dt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ft=["disabled"],ht={key:0,class:"spinner-border spinner-border-sm me-2"},w={__name:"LoadingButton",props:{action:Function},setup(C){const A=C,p=g(!1);async function $(){p.value=!0;try{await A.action()}finally{p.value=!1}}return(r,c)=>(o(),n("button",{disabled:p.value,onClick:$,class:"btn btn-primary"},[p.value?(o(),n("span",ht)):f("",!0),W(r.$slots,"default")],8,ft))}},mt={class:"my-2"},_t={class:"my-2"},kt={class:"my-2"},pt={class:"my-2"},bt={class:"my-2"},vt={class:"my-2"},yt={class:"my-2"},wt={key:0},gt={class:"table table-sm table-bordered"},Ct={key:0},Et={class:"link"},St=["href"],Tt={class:"me-2"},At=["href"],$t={key:1},Lt={class:"table table-sm table-bordered"},xt={key:0},Pt={class:"link"},Ft=["href"],jt={class:"me-2"},Bt=["href"],Ot={key:2},Dt={class:"table table-sm table-bordered"},It={key:0},Ut={class:"link"},Nt=["href"],Vt={class:"me-2"},Ht=["href"],Mt={key:3},qt={class:"table table-sm table-bordered"},Rt={key:0},Kt={class:"link"},Wt=["href"],zt={class:"me-2"},Gt=["href"],Qt={__name:"Crawler",setup(C){const A=z(),p=G();Q(()=>{console.log("startCrawler"),T(),document.showToast=(e="",t="success")=>{const _=t==="success"?5e3:6e4;A.add({severity:t,detail:e,life:_}),t==="error"&&console.log(e)},document.confirmDialog=async e=>new Promise((t,_)=>{p.require({message:e,header:"",icon:"fas fa-question",acceptLabel:"Да",rejectLabel:"Нет",accept:()=>t(!0),reject:()=>t(!1)})})});async function $(e){return new Promise(t=>setTimeout(t,e))}Y(()=>{});const r=g({}),c=g({}),b=g(!1),S=g("start"),L=g(!1);async function P(e){return await v({command:"processUrl",url:e})}function I(e){try{return new URL(e).href}catch{return new URL(e,location.origin).href}}async function U(e){if(b.value)return;const t=await P(I(e));if(!t.check)throw new Error(t.code);const _=t.body;return[...new DOMParser().parseFromString(_,"text/html").querySelectorAll("a")].map(l=>l.getAttribute("href")).filter(Boolean)}async function N(){if(r.value={},c.value={},S.value="working",b.value)return;await j(),await F("/","");let e={};Object.keys(r.value).sort().forEach(t=>{e[t]=r.value[t]}),r.value=e,await V(),e={},Object.keys(c.value).sort().forEach(t=>{e[t]=c.value[t]}),c.value=e,S.value="end"}async function V(){if(!b.value)for(let e in c.value){const t=await P(e);c.value[e].status="done",c.value[e].check=t.check?"ok":t.code}}async function F(e,t){if(b.value||["#","/a_dmin","/f_ilament"].some(a=>e.startsWith(a)))return;if(["//","http://","https://"].some(a=>e.startsWith(a))){e in c.value||(c.value[e]={status:"reading",check:"unknown",parentArr:[]}),c.value[e].parentArr.push(t);return}if(e in r.value){r.value[e].check!="ok"&&r.value[e].parentArr.push(t);return}r.value[e]={status:"reading",check:"unknown",parentArr:[t]};try{const a=await U(e);r.value[e].check="ok";for(const l of a){if(b.value)return;await F(l,e)}}catch(a){r.value[e].check=a.message}finally{r.value[e].status="done"}}async function j(){await v({command:"deleteFromStorage"}),document.showToast("кеш удален")}async function H(){await v({command:"deleteFromPublic"}),document.showToast("кеш удален"),await T()}async function M(){await v({command:"startHtmlCache"}),document.showToast("кеш опубликован"),await T()}async function q(){const e=await v({command:"listCacheFiles"});r.value={},c.value={},e.forEach(t=>{r.value[t]={status:"file",check:"ok",parentArr:[]}}),S.value="end",document.showToast("кеш считан")}async function T(){await $(2e3);const e=await v({command:"getIniParams"});document.showToast("Готово"),L.value=e?.STATIC_HTML_ENABLE}const R=B(()=>{for(const e in r.value)if(r.value[e]?.check!="ok"&&r.value[e]?.check!="reading")return!0;return!1}),K=B(()=>{for(const e in c.value)if(r.value[e]?.check!="ok"&&r.value[e]?.check!="reading")return!0;return!1});return(e,t)=>{const _=O("Toast"),x=O("ConfirmDialog");return o(),n(u,null,[t[12]||(t[12]=s("h1",null,"Crawler 0.7",-1)),s("div",mt,[t[1]||(t[1]=k(" Статус кеша ",-1)),s("button",{class:Z(["btn btn-secondary fas fa-circle",{"btn-success ":L.value,"btn-secondary":!L.value}])},null,2)]),s("div",_t,[h(w,{action:T},{default:y(()=>[...t[2]||(t[2]=[k("Считать параметры",-1)])]),_:1})]),s("div",kt,[h(w,{action:q},{default:y(()=>[...t[3]||(t[3]=[k("Считать сторадж",-1)])]),_:1})]),s("div",pt,[h(w,{action:j},{default:y(()=>[...t[4]||(t[4]=[k("Удалить в сторадж",-1)])]),_:1})]),s("div",bt,[h(w,{action:M},{default:y(()=>[...t[5]||(t[5]=[k("Опубликовать сторадж",-1)])]),_:1})]),s("div",vt,[h(w,{action:H},{default:y(()=>[...t[6]||(t[6]=[k("Удалить паблик",-1)])]),_:1})]),s("div",yt,[h(w,{action:N},{default:y(()=>[...t[7]||(t[7]=[k("Старт",-1)])]),_:1}),S.value=="working"?(o(),n("button",{key:0,class:"btn btn-danger fas fa-stop ms-3",onClick:t[0]||(t[0]=a=>b.value=!0)})):f("",!0)]),R.value?(o(),n("div",wt,[t[8]||(t[8]=s("h3",null,"Error",-1)),s("table",gt,[s("tbody",null,[(o(!0),n(u,null,m(r.value,(a,l)=>(o(),n(u,{key:l},[a.check!="ok"?(o(),n("tr",Ct,[s("td",Et,[s("a",{href:l,target:"_blank"},i(l),9,St)]),s("td",null,i(a.status),1),s("td",null,i(a.check),1),s("td",null,[(o(!0),n(u,null,m(a.parentArr,d=>(o(),n("span",Tt,[s("a",{href:d,target:"_blank"},i(d),9,At)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),Object.keys(r.value).length>0?(o(),n("div",$t,[t[9]||(t[9]=s("h3",null,"Ok",-1)),s("table",Lt,[s("tbody",null,[(o(!0),n(u,null,m(r.value,(a,l)=>(o(),n(u,{key:l},[a.check=="ok"?(o(),n("tr",xt,[s("td",Pt,[s("a",{href:l,target:"_blank"},i(l),9,Ft)]),s("td",null,i(a.status),1),s("td",null,i(a.check),1),s("td",null,[(o(!0),n(u,null,m(a.parentArr,d=>(o(),n("span",jt,[s("a",{href:d,target:"_blank"},i(d),9,Bt)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),K.value?(o(),n("div",Ot,[t[10]||(t[10]=s("h2",null,"External Error",-1)),s("table",Dt,[s("tbody",null,[(o(!0),n(u,null,m(c.value,(a,l)=>(o(),n(u,{key:l},[a.check!="ok"?(o(),n("tr",It,[s("td",Ut,[s("a",{href:l,target:"_blank"},i(l),9,Nt)]),s("td",null,i(a.status),1),s("td",null,i(a.check),1),s("td",null,[(o(!0),n(u,null,m(a.parentArr,d=>(o(),n("span",Vt,[s("a",{href:d,target:"_blank"},i(d),9,Ht)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),Object.keys(c.value).length>1?(o(),n("div",Mt,[t[11]||(t[11]=s("h2",null,"External OK",-1)),s("table",qt,[s("tbody",null,[(o(!0),n(u,null,m(c.value,(a,l)=>(o(),n(u,{key:l},[a.check=="ok"?(o(),n("tr",Rt,[s("td",Kt,[s("a",{href:l,target:"_blank"},i(l),9,Wt)]),s("td",null,i(a.status),1),s("td",null,i(a.check),1),s("td",null,[(o(!0),n(u,null,m(a.parentArr,d=>(o(),n("span",zt,[s("a",{href:d,target:"_blank"},i(d),9,Gt)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),h(_,{position:"top-left"}),h(x)],64)}}},Yt=dt(Qt,[["__scopeId","data-v-48ebd0f3"]]),Zt=[D,X,tt,et,st,at,nt,ot,rt,ut],E=J(Yt);Zt.forEach(C=>{E.component(C.name,C)});E.use(lt,{theme:{preset:ct,options:{cssLayer:{name:"primevue",order:"theme, base, primevue"}}}});E.use(it);E.use(D);E.mount("#crawler");
