import{Y as V,Z as H,R as M,$ as q,b as v,af as p,I as S,c as a,o,a as e,y as f,L as E,M as R,D as W,F as d,G as b,H as c,a0 as z,a1 as L,a2 as G,a3 as K,a4 as Q,a5 as Y,a6 as Z,a7 as J,a8 as X,a9 as tt,aa as et,ab as st,ac as nt}from"./apiCall-CPsueVi4.js";import{s as at}from"./index-DQP_ltDA.js";import{_ as ot}from"./_plugin-vue_export-helper-DlAUqK2U.js";const rt={class:"my-2"},lt={class:"my-2"},ct={class:"my-2"},it={class:"my-2"},ut={class:"my-2"},dt={class:"my-2"},mt={class:"my-2"},ht={key:0},ft={class:"table table-sm table-bordered"},bt={key:0},_t={class:"link"},kt=["href"],pt={class:"me-2"},vt=["href"],yt={class:"table table-sm table-bordered"},wt={key:0},gt={class:"link"},Ct=["href"],Tt={class:"me-2"},$t=["href"],At={key:0},St={class:"table table-sm table-bordered"},Et={key:0},Lt={class:"link"},Pt=["href"],xt={class:"me-2"},Ft=["href"],jt={class:"table table-sm table-bordered"},Bt={key:0},Dt={class:"link"},Ot=["href"],Ut={class:"me-2"},It=["href"],Nt={__name:"Crawler",setup(w){const P=V(),x=H();M(()=>{console.log("startCrawler"),C(),document.showToast=(s="",t="success")=>{const u=t==="success"?5e3:6e4;P.add({severity:t,detail:s,life:u}),t==="error"&&console.log(s)},document.confirmDialog=async s=>new Promise((t,u)=>{x.require({message:s,header:"",icon:"fas fa-question",acceptLabel:"Да",rejectLabel:"Нет",accept:()=>t(!0),reject:()=>t(!1)})})});async function F(s){return new Promise(t=>setTimeout(t,s))}q(()=>{});const l=v({}),i=v({}),_=v(!1),k=v("start"),g=v(!1);async function T(s){return await p({command:"processUrl",url:s})}function j(s){try{return new URL(s).href}catch{return new URL(s,location.origin).href}}async function B(s){if(!_.value)try{const t=await T(j(s));if(!t.check)return reject({error:t.code});const u=t.body;return[...new DOMParser().parseFromString(u,"text/html").querySelectorAll("a")].map(r=>r.getAttribute("href")).filter(Boolean)}catch(t){document.showToast(t.message,"error")}}async function D(s,t){if(l.value={},i.value={},k.value="working",_.value)return;await A(),await $(s,t);let u={};Object.keys(l.value).sort().forEach(h=>{u[h]=l.value[h]}),l.value=u,await O(),u={},Object.keys(i.value).sort().forEach(h=>{u[h]=i.value[h]}),i.value=u,k.value="end"}async function O(){if(!_.value)for(let s in i.value)try{const t=await T(s);i.value[s].status="done",i.value[s].check=t.check?"ok":t.code}catch(t){document.showToast(t.message,"error")}}async function $(s,t){if(_.value||["#","/a_dmin","/f_ilament"].some(n=>s.startsWith(n)))return;if(["//","http://","https://"].some(n=>s.startsWith(n))){s in i.value||(i.value[s]={status:"reading",check:"unknown",parentArr:[]}),i.value[s].parentArr.push(t);return}if(s in l.value){l.value[s].check!="ok"&&l.value[s].parentArr.push(t);return}l.value[s]={status:"reading",check:"unknown",parentArr:[t]};try{const n=await B(s);l.value[s].check="ok";for(const r of n){if(_.value)return;await $(r,s)}}catch(n){l.value[s].check=n.error}finally{l.value[s].status="done"}}async function A(){await p({command:"deleteFromStorage"}),document.showToast("кеш удален")}async function U(){await p({command:"deleteFromPublic"}),document.showToast("кеш удален")}async function I(){await p({command:"startHtmlCache"}),document.showToast("кеш опубликован"),await C()}async function N(){const s=await p({command:"listCacheFiles"});l.value={},i.value={},s.data.forEach(t=>{l.value[t]={status:"file",check:"ok",parentArr:[]}}),k.value="end",document.showToast("кеш считан")}async function C(){await F(2e3);const s=await p({command:"getIniParams"});document.showToast("Готово"),g.value=s?.STATIC_HTML_ENABLE}return(s,t)=>{const u=S("Toast"),h=S("ConfirmDialog");return o(),a(d,null,[t[12]||(t[12]=e("h1",null,"Crawler 0.7",-1)),e("div",rt,[t[7]||(t[7]=R(" Статус кеша ",-1)),e("button",{class:W(["btn btn-secondary fas fa-circle",{"btn-success ":g.value,"btn-secondary":!g.value}])},null,2)]),e("div",lt,[e("button",{class:"btn btn-primary",onClick:t[0]||(t[0]=n=>C())},"Считать параметры")]),e("div",ct,[e("button",{class:"btn btn-primary",onClick:t[1]||(t[1]=n=>N())},"Считать кеш")]),e("div",it,[e("button",{class:"btn btn-primary",onClick:t[2]||(t[2]=n=>I())},"Опубликовать кеш")]),e("div",ut,[e("button",{class:"btn btn-primary",onClick:t[3]||(t[3]=n=>U())},"Удалить в паблике")]),e("div",dt,[e("button",{class:"btn btn-primary",onClick:t[4]||(t[4]=n=>A())},"Удалить в сторадже")]),e("div",mt,[k.value!="working"?(o(),a("button",{key:0,class:"btn btn-primary",onClick:t[5]||(t[5]=n=>D("/",""))},"Построить кеш")):f("",!0),k.value=="working"?(o(),a("button",{key:1,class:"btn btn-danger fas fa-stop ms-3",onClick:t[6]||(t[6]=n=>_.value=!0)})):f("",!0)]),k.value!="start"?(o(),a("div",ht,[t[9]||(t[9]=e("h3",null,"Error",-1)),e("table",ft,[e("tbody",null,[(o(!0),a(d,null,b(l.value,(n,r)=>(o(),a(d,{key:r},[n.check!="ok"?(o(),a("tr",bt,[e("td",_t,[e("a",{href:r,target:"_blank"},c(r),9,kt)]),e("td",null,c(n.status),1),e("td",null,c(n.check),1),e("td",null,[(o(!0),a(d,null,b(n.parentArr,m=>(o(),a("span",pt,[e("a",{href:m,target:"_blank"},c(m),9,vt)]))),256))])])):f("",!0)],64))),128))])]),t[10]||(t[10]=e("h3",null,"Ok",-1)),e("table",yt,[e("tbody",null,[(o(!0),a(d,null,b(l.value,(n,r)=>(o(),a(d,{key:r},[n.check=="ok"?(o(),a("tr",wt,[e("td",gt,[e("a",{href:r,target:"_blank"},c(r),9,Ct)]),e("td",null,c(n.status),1),e("td",null,c(n.check),1),e("td",null,[(o(!0),a(d,null,b(n.parentArr,m=>(o(),a("span",Tt,[e("a",{href:m,target:"_blank"},c(m),9,$t)]))),256))])])):f("",!0)],64))),128))])]),Object.keys(l.value).length>1?(o(),a("div",At,[t[8]||(t[8]=e("h2",null,"External Error",-1)),e("table",St,[e("tbody",null,[(o(!0),a(d,null,b(i.value,(n,r)=>(o(),a(d,{key:r},[n.check!="ok"?(o(),a("tr",Et,[e("td",Lt,[e("a",{href:r,target:"_blank"},c(r),9,Pt)]),e("td",null,c(n.status),1),e("td",null,c(n.check),1),e("td",null,[(o(!0),a(d,null,b(n.parentArr,m=>(o(),a("span",xt,[e("a",{href:m,target:"_blank"},c(m),9,Ft)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),t[11]||(t[11]=e("h2",null,"External OK",-1)),e("table",jt,[e("tbody",null,[(o(!0),a(d,null,b(i.value,(n,r)=>(o(),a(d,{key:r},[n.check=="ok"?(o(),a("tr",Bt,[e("td",Dt,[e("a",{href:r,target:"_blank"},c(r),9,Ot)]),e("td",null,c(n.status),1),e("td",null,c(n.check),1),e("td",null,[(o(!0),a(d,null,b(n.parentArr,m=>(o(),a("span",Ut,[e("a",{href:m,target:"_blank"},c(m),9,It)]))),256))])])):f("",!0)],64))),128))])])])):f("",!0),E(u,{position:"bottom-right"}),E(h)],64)}}},Vt=ot(Nt,[["__scopeId","data-v-e09339b5"]]),Ht=[L,G,K,Q,Y,Z,J,X,tt,at],y=z(Vt);Ht.forEach(w=>{y.component(w.name,w)});y.use(et,{theme:{preset:st,options:{cssLayer:{name:"primevue",order:"theme, base, primevue"}}}});y.use(nt);y.use(L);y.mount("#crawler");
