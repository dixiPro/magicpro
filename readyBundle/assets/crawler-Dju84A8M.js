import{r as f,l as r,p as o,s as h,R as q,u as M,N as z,n as P,ae as m,d as G,q as t,H as R,z as s,v as _,E as Q,G as C,J as E,F as p,C as D,_ as Z,t as A,Z as K,$ as O,a0 as Y,a1 as tt,a2 as et,a3 as at,a4 as st,a5 as nt,a6 as ot,a7 as rt,a8 as lt,a9 as ct,aa as ut,ab as it}from"./translate-ACaeD73l.js";import{s as dt}from"./index-pJ5qO2LS.js";import{_ as _t}from"./_plugin-vue_export-helper-DlAUqK2U.js";const vt=["disabled"],ht={key:0,class:"spinner-border spinner-border-sm me-2"},$={__name:"LoadingButton",props:{action:Function},setup(b){const l=b,v=f(!1);async function y(){v.value=!0;try{await l.action()}finally{v.value=!1}}return(n,g)=>(o(),r("button",{disabled:v.value,onClick:y,class:"btn btn-primary"},[v.value?(o(),r("span",ht)):h("",!0),q(n.$slots,"default")],8,vt))}},ft={class:"table table-sm table-bordered"},mt={class:"fixed150"},pt=["textContent"],kt=["textContent"],wt=["textContent"],bt=["textContent"],yt={key:0},gt={class:"my-2"},St={key:0},Rt={class:"my-2"},Ct={class:"my-2"},Et={key:1},Dt={class:"my-2"},$t={key:2},xt={class:"table table-sm table-bordered"},Ut={key:0},Lt={class:"link"},Nt=["href"],Tt={class:"me-2"},Ft=["href"],Pt={key:3},At={class:"table table-sm table-bordered"},Ot={key:0},Bt={class:"link"},Vt=["href"],It={key:0},Jt={class:"me-2"},Wt=["href"],jt={__name:"Crawler",setup(b){const{t:l}=M();let v=f({});const y=f(!1),n=f({}),g=f(!1),k=f("start"),d=f({total:0,error:0,saveStatus:0,nowReading:""});function L(){d.value.total=0,d.value.error=0,d.value.saveStatus=0,d.value.nowReading=0}const N=f(!1),T=f(!1);z(()=>{console.log("startCrawler"),S()});async function B(){function e(a){try{const c=JSON.parse(a);return c&&typeof c=="object"?c:{}}catch{return{}}}const u=await m({command:"getCrawlerResults"});n.value=e(u.result),L();for(const a in n.value){d.value.total++;const c=A(n.value)[a];c.saveStatus&&d.value.saveStatus++,c.check!="ok"&&d.value.error++}}async function S(){try{y.value=!1,await P(),v.value=await m({command:"getIniParams"}),v.value.EXCLUDED_ROUTES=v.value.EXCLUDED_ROUTES.map(u=>{let a=x(u);return a=a.replace(/\/+$/,""),a}),v.value.RENDER_URL=v.value.RENDER_URL.map(u=>{let a=x(u);return a=a.replace(/\/+$/,""),a});const e=await m({command:"getDirStatus"});N.value=e.storageDirStatus,T.value=e.publicDirStatus,await B(),await P(),y.value=!0}catch(e){console.log(e)}}async function V(){const e=JSON.stringify(A(n.value),null,2);await m({command:"saveCrawlerResults",savedData:e})}function x(e){try{return new URL(e).href}catch{return new URL(e,location.origin).href}}function I(e){return[...new DOMParser().parseFromString(e,"text/html").querySelectorAll("a")].map(c=>c.getAttribute("href")).filter(Boolean)}async function J(){if(g.value)return;n.value={},k.value="working",L(),await F();for(const u of v.value.RENDER_URL)await U(u,"");await U("/","");let e={};Object.keys(n.value).sort().forEach(u=>{e[u]=n.value[u]}),n.value=e,await V(),k.value="start",await S()}async function U(e,u){if(d.value.nowReading=e,g.value||(e=e.replace(/#([^?]*)/g,""),e=x(e),v.value.EXCLUDED_ROUTES.some(i=>e.startsWith(i))))return;if(e in n.value){n.value[e].check!="ok"&&n.value[e].parentArr.push(u);return}n.value[e]={status:"reading",check:"unknown",saveStatus:!1,parentArr:[u]};const a=new URL(e),c=e.startsWith(location.origin)&&(v.value.RENDER_URL.some(i=>e.startsWith(i))||!a.pathname.includes("."));try{const i=await m({command:"processUrl",url:e,saveToFile:c});if(!i.check)throw new Error(i.code);if(d.value.total++,n.value[e].check="ok",n.value[e].saveStatus=i.saveStatus,i.saveStatus&&d.value.saveStatus++,!e.startsWith(location.origin))return;const H=I(i.body);for(const X of H){if(g.value)return;await U(X,e)}}catch(i){n.value[e].check=i.message,d.value.error++}finally{n.value[e].status="done"}}async function F(){await m({command:"deleteFromStorage"}),document.showToast(l("toast_storage_deleted")),await S()}async function W(){await m({command:"deleteFromPublic"}),document.showToast(l("toast_public_deleted")),await S()}async function j(){await m({command:"startHtmlCache"}),await S(),document.showToast(l("toast_cache_published"))}return G(()=>{for(const e in n.value)if(n.value[e]?.check!="ok"&&n.value[e]?.check!="reading")return!0;return!1}),(e,u)=>(o(),r(p,null,[t("h2",null,s(_(l)("crawler")),1),t("table",ft,[t("tbody",null,[t("tr",null,[t("td",mt,s(_(l)("total")),1),t("td",null,[t("span",{textContent:s(d.value.total)},null,8,pt)])]),t("tr",null,[t("td",null,s(_(l)("errors")),1),t("td",null,[t("span",{textContent:s(d.value.error)},null,8,kt)])]),t("tr",null,[t("td",null,s(_(l)("saved")),1),t("td",null,[t("span",{textContent:s(d.value.saveStatus)},null,8,wt)])]),t("tr",null,[t("td",null,s(_(l)("now_reading")),1),t("td",null,[t("span",{textContent:s(d.value.nowReading)},null,8,bt)])])])]),y.value?(o(),r("div",yt,[t("div",gt,[k.value=="start"?(o(),Q($,{key:0,action:J},{default:C(()=>[E(s(_(l)("start")),1)]),_:1})):h("",!0),k.value=="working"?(o(),r("button",{key:1,class:"btn btn-danger fas fa-stop ms-3",onClick:u[0]||(u[0]=a=>g.value=!0)})):h("",!0)]),N.value?(o(),r("div",St,[t("h4",null,s(_(l)("cache_created")),1),t("div",Rt,[R($,{action:F},{default:C(()=>[E(s(_(l)("delete_storage")),1)]),_:1})]),t("div",Ct,[R($,{action:j},{default:C(()=>[E(s(_(l)("publish_storage")),1)]),_:1})])])):h("",!0),T.value?(o(),r("div",Et,[t("h4",null,s(_(l)("cache_published")),1),t("div",Dt,[R($,{action:W},{default:C(()=>[E(s(_(l)("delete_published_cache")),1)]),_:1})])])):h("",!0),k.value=="start"?(o(),r("div",$t,[t("h3",null,s(_(l)("errors")),1),t("table",xt,[t("tbody",null,[(o(!0),r(p,null,D(n.value,(a,c)=>(o(),r(p,{key:c},[a.check!="ok"?(o(),r("tr",Ut,[t("td",Lt,[t("a",{href:c,target:"_blank"},s(c),9,Nt)]),t("td",null,s(a.status),1),t("td",null,s(a.check),1),t("td",null,[(o(!0),r(p,null,D(a.parentArr,i=>(o(),r("span",Tt,[t("a",{href:i,target:"_blank"},s(i),9,Ft)]))),256))])])):h("",!0)],64))),128))])])])):h("",!0),k.value=="start"?(o(),r("div",Pt,[t("h3",null,s(_(l)("ok")),1),t("table",At,[t("tbody",null,[(o(!0),r(p,null,D(n.value,(a,c)=>(o(),r(p,{key:c},[a.check=="ok"?(o(),r("tr",Ot,[t("td",Bt,[t("a",{href:c,target:"_blank"},s(c),9,Vt)]),t("td",null,s(a.status),1),t("td",null,s(a.check),1),t("td",null,[a.saveStatus?(o(),r("span",It,s(_(l)("saved_lower")),1)):h("",!0)]),t("td",null,[(o(!0),r(p,null,D(a.parentArr,i=>(o(),r("span",Jt,[t("a",{href:i,target:"_blank"},s(i),9,Wt)]))),256))])])):h("",!0)],64))),128))])])])):h("",!0)])):h("",!0),R(Z)],64))}},Ht=_t(jt,[["__scopeId","data-v-795cf231"]]),Xt=[O,Y,tt,et,at,st,nt,ot,rt,dt],w=K(Ht);Xt.forEach(b=>{w.component(b.name,b)});w.use(lt,{theme:{preset:ct,options:{cssLayer:{name:"primevue",order:"theme, base, primevue"}}}});w.use(ut);w.use(O);w.use(it);w.mount("#crawler");
